<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melodía Legendaria</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            touch-action: manipulation;
        }
        
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #222;
            border: 4px solid #FF6D00;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #FF6D00;
            font-size: 18px;
            text-shadow: 2px 2px 2px #000;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .mobile-btn {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 109, 0, 0.5);
            border: 3px solid #FF6D00;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
        }
        
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #FF6D00;
            z-index: 10;
        }
        
        #startScreen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            color: #FF6D00;
        }
        
        #startScreen p {
            font-size: 18px;
            max-width: 600px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        #startButton {
            padding: 15px 30px;
            background-color: #FF6D00;
            color: black;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #startButton:hover {
            background-color: #FF8F00;
        }
        
        #continueButton {
            padding: 15px 30px;
            background-color: #FF8F00;
            color: black;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        #continueButton:hover {
            background-color: #FFB300;
        }
        
        #levelComplete {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #FF6D00;
            z-index: 10;
        }
        
        #levelComplete h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #nextLevelButton {
            padding: 15px 30px;
            background-color: #FF6D00;
            color: black;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        #gameOver {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #FF6D00;
            z-index: 10;
        }
        
        #gameOver h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #restartButton {
            padding: 15px 30px;
            background-color: #FF6D00;
            color: black;
            border: none;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        #damageText {
            position: absolute;
            color: red;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 2px black;
            z-index: 5;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    
    <div id="damageText">¡¡Mierda!!</div>
    
    <div id="ui">
        Nivel: <span id="levelDisplay">1</span> | 
        Notas: <span id="notesDisplay">0</span> | 
        Vidas: <span id="livesDisplay">3</span>
    </div>
    
    <div id="controls">
        <div class="mobile-btn" id="leftBtn">←</div>
        <div class="mobile-btn" id="jumpBtn">↑</div>
        <div class="mobile-btn" id="rightBtn">→</div>
        <div class="mobile-btn" id="attackBtn">A</div>
    </div>
    
    <div id="startScreen">
        <h1>Melodía Legendaria</h1>
        <p>Ayuda a Ritmo a recuperar las Notas Sagradas robadas por el malvado Silencio. 
           Supera 10 niveles musicales, sincronizando tus movimientos con el ritmo de la música. 
           ¡Devuelve la armonía al mundo!</p>
        <button id="startButton">Nueva Partida</button>
        <button id="continueButton" style="display: none;">Continuar Partida</button>
    </div>
    
    <div id="levelComplete">
        <h2>¡Nivel Completado!</h2>
        <p>Notas recolectadas: <span id="notesCollected">0</span></p>
        <p>¡+3 vidas por completar el nivel!</p>
        <button id="nextLevelButton">Siguiente Nivel</button>
    </div>
    
    <div id="gameOver">
        <h2>¡Game Over!</h2>
        <p>Silencio está ganando... ¿Intentarás de nuevo?</p>
        <button id="restartButton">Reintentar</button>
    </div>
    
    <script>
        // Configuración del juego
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const levelDisplay = document.getElementById('levelDisplay');
        const notesDisplay = document.getElementById('notesDisplay');
        const livesDisplay = document.getElementById('livesDisplay');
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const continueButton = document.getElementById('continueButton');
        const levelComplete = document.getElementById('levelComplete');
        const nextLevelButton = document.getElementById('nextLevelButton');
        const notesCollected = document.getElementById('notesCollected');
        const gameOver = document.getElementById('gameOver');
        const restartButton = document.getElementById('restartButton');
        const damageText = document.getElementById('damageText');
        
        // Controles móviles
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const jumpBtn = document.getElementById('jumpBtn');
        const attackBtn = document.getElementById('attackBtn');
        
        // Ajustar tamaño del canvas para móviles
        function resizeCanvas() {
            const maxWidth = window.innerWidth - 20;
            const maxHeight = window.innerHeight - 200;
            const ratio = canvas.width / canvas.height;
            
            if (maxWidth / ratio <= maxHeight) {
                canvas.style.width = maxWidth + 'px';
                canvas.style.height = (maxWidth / ratio) + 'px';
            } else {
                canvas.style.height = maxHeight + 'px';
                canvas.style.width = (maxHeight * ratio) + 'px';
            }
            
            // Mostrar controles solo en móviles
            const controls = document.getElementById('controls');
            controls.style.display = window.innerWidth < 768 ? 'flex' : 'none';
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Función para mostrar texto de daño
        function showDamageText(x, y) {
            damageText.style.left = x + 'px';
            damageText.style.top = y + 'px';
            damageText.style.display = 'block';
            
            // Animación
            let opacity = 1;
            let posY = y;
            const anim = setInterval(() => {
                opacity -= 0.05;
                posY -= 2;
                damageText.style.opacity = opacity;
                damageText.style.top = posY + 'px';
                
                if (opacity <= 0) {
                    clearInterval(anim);
                    damageText.style.display = 'none';
                }
            }, 50);
        }
        
        // Variables del juego
        let gameRunning = false;
        let currentLevel = 1;
        let notes = 0;
        let lives = 3;
        let player;
        let platforms = [];
        let enemies = [];
        let notesItems = [];
        let backgroundObjects = [];
        let beatTimer = 0;
        let beatInterval = 1000; // 1 segundo = 60 BPM
        let onBeat = false;
        let lastBeatTime = 0;
        let levelMusic = [];
        let soundEffects = [];
        
        // Guardar progreso
        function saveGame() {
            const gameData = {
                level: currentLevel,
                notes: notes,
                lives: lives
            };
            localStorage.setItem('melodiaLegendariaSave', JSON.stringify(gameData));
        }
        
        // Cargar progreso
        function loadGame() {
            const savedData = localStorage.getItem('melodiaLegendariaSave');
            if (savedData) {
                const gameData = JSON.parse(savedData);
                currentLevel = gameData.level;
                notes = gameData.notes;
                lives = gameData.lives;
                return true;
            }
            return false;
        }
        
        // Mostrar botón de continuar si hay partida guardada
        if (loadGame()) {
            continueButton.style.display = 'block';
        }
        
        // Clase del jugador
        class Player {
            constructor() {
                this.width = 40;
                this.height = 60;
                this.x = 100;
                this.y = canvas.height - this.height - 50;
                this.velocityX = 0;
                this.velocityY = 0;
                this.speed = 5;
                this.jumpPower = 12;
                this.isJumping = false;
                this.facingRight = true;
                this.attackCooldown = 0;
                this.invincible = 0;
                this.animationFrame = 0;
                this.animationTimer = 0;
                this.specialAbility = null;
                this.beatAccuracy = 0;
            }
            
            update() {
                // Movimiento horizontal
                this.x += this.velocityX;
                
                // Gravedad
                this.velocityY += 0.5;
                this.y += this.velocityY;
                
                // Límites del canvas
                if (this.x < 0) this.x = 0;
                if (this.x > canvas.width - this.width) this.x = canvas.width - this.width;
                if (this.y > canvas.height - this.height - 50) {
                    this.y = canvas.height - this.height - 50;
                    this.velocityY = 0;
                    this.isJumping = false;
                }
                
                // Colisión con plataformas
                for (const platform of platforms) {
                    if (this.y + this.height >= platform.y && 
                        this.y < platform.y && 
                        this.x + this.width > platform.x && 
                        this.x < platform.x + platform.width && 
                        this.velocityY > 0) {
                        this.y = platform.y - this.height;
                        this.velocityY = 0;
                        this.isJumping = false;
                    }
                }
                
                // Enfriamiento de ataque
                if (this.attackCooldown > 0) {
                    this.attackCooldown--;
                }
                
                // Invencibilidad
                if (this.invincible > 0) {
                    this.invincible--;
                }
                
                // Animación
                this.animationTimer++;
                if (this.animationTimer > 10) {
                    this.animationFrame = (this.animationFrame + 1) % 4;
                    this.animationTimer = 0;
                }
                
                // Actualizar precisión del ritmo
                if (onBeat && (this.velocityX !== 0 || this.attackCooldown === 20)) {
                    this.beatAccuracy = Math.min(100, this.beatAccuracy + 2);
                } else if (!onBeat && (this.velocityX !== 0 || this.attackCooldown === 20)) {
                    this.beatAccuracy = Math.max(0, this.beatAccuracy - 1);
                }
                
                // Habilidad especial
                if (this.specialAbility === 'doubleJump' && !this.isJumping && onBeat && this.velocityY < -5) {
                    this.velocityY = -this.jumpPower * 0.8;
                    this.isJumping = true;
                    createSoundEffect('jump');
                }
            }
            
            draw() {
                // Dibujar al jugador
                ctx.save();
                if (this.invincible > 0 && Math.floor(this.invincible / 5) % 2 === 0) {
                    ctx.globalAlpha = 0.5;
                }
                
                // Cuerpo (naranja)
                ctx.fillStyle = '#FF6D00';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Detalles (negro)
                ctx.fillStyle = '#000';
                // Cabeza
                ctx.fillRect(this.x + 10, this.y + 5, 20, 20);
                // Brazos y piernas según animación
                if (this.animationFrame === 0 || this.animationFrame === 2) {
                    // Brazos abajo
                    ctx.fillRect(this.x, this.y + 25, 10, 15);
                    ctx.fillRect(this.x + 30, this.y + 25, 10, 15);
                    // Piernas juntas
                    ctx.fillRect(this.x + 10, this.y + 45, 8, 15);
                    ctx.fillRect(this.x + 22, this.y + 45, 8, 15);
                } else {
                    // Brazos en movimiento
                    ctx.fillRect(this.x - 5, this.y + 20, 10, 15);
                    ctx.fillRect(this.x + 35, this.y + 20, 10, 15);
                    // Piernas en movimiento
                    if (this.animationFrame === 1) {
                        ctx.fillRect(this.x + 5, this.y + 45, 8, 15);
                        ctx.fillRect(this.x + 27, this.y + 45, 8, 15);
                    } else {
                        ctx.fillRect(this.x + 15, this.y + 45, 8, 15);
                        ctx.fillRect(this.x + 17, this.y + 45, 8, 15);
                    }
                }
                
                // Instrumento (guitarra)
                ctx.fillStyle = '#333';
                ctx.fillRect(this.x + (this.facingRight ? 25 : -15), this.y + 20, 30, 10);
                
                // Ataque si está activo
                if (this.attackCooldown > 20) {
                    ctx.fillStyle = 'rgba(255, 200, 0, 0.7)';
                    ctx.beginPath();
                    ctx.arc(
                        this.x + (this.facingRight ? this.width + 20 : -20), 
                        this.y + this.height / 2, 
                        30, 
                        0, 
                        Math.PI * 2
                    );
                    ctx.fill();
                }
                
                // Efecto de ritmo si está en beat
                if (onBeat) {
                    ctx.strokeStyle = 'rgba(255, 255, 0, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(
                        this.x + this.width / 2, 
                        this.y + this.height / 2, 
                        this.width + 10, 
                        0, 
                        Math.PI * 2
                    );
                    ctx.stroke();
                }
                
                ctx.restore();
            }
            
            jump() {
                if (!this.isJumping) {
                    this.velocityY = -this.jumpPower;
                    this.isJumping = true;
                    createSoundEffect('jump');
                    
                    // Bonus por saltar en el ritmo
                    if (onBeat) {
                        this.velocityY *= 1.2;
                    }
                }
            }
            
            attack() {
                if (this.attackCooldown === 0) {
                    this.attackCooldown = 30;
                    createSoundEffect('attack');
                    
                    // Daño extra si atacas en el ritmo
                    const damage = onBeat ? 2 : 1;
                    
                    // Verificar golpe a enemigos
                    for (let i = 0; i < enemies.length; i++) {
                        const enemy = enemies[i];
                        const attackX = this.x + (this.facingRight ? this.width + 20 : -20);
                        const attackY = this.y + this.height / 2;
                        
                        if (Math.abs(attackX - (enemy.x + enemy.width / 2)) < 40 && 
                            Math.abs(attackY - (enemy.y + enemy.height / 2)) < 40) {
                            enemy.health -= damage;
                            
                            if (enemy.health <= 0) {
                                enemies.splice(i, 1);
                                i--;
                                createSoundEffect('enemyDefeat');
                            }
                        }
                    }
                }
            }
        }
        
        // Clase de plataforma
        class Platform {
            constructor(x, y, width, height, color = '#333', moving = false) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.color = color;
                this.moving = moving;
                this.direction = 1;
                this.originalX = x;
            }
            
            update() {
                if (this.moving) {
                    this.x += this.direction;
                    if (this.x > this.originalX + 100 || this.x < this.originalX - 100) {
                        this.direction *= -1;
                    }
                }
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Patrón de teclas de piano si es nivel 4
                if (currentLevel === 4) {
                    ctx.fillStyle = '#000';
                    const keyWidth = this.width / 7;
                    for (let i = 0; i < 7; i++) {
                        ctx.fillRect(this.x + i * keyWidth, this.y, 2, this.height);
                    }
                }
            }
        }
        
        // Clase de enemigo
        class Enemy {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.width = 40;
                this.height = 40;
                this.type = type;
                this.health = 3;
                this.direction = 1;
                this.speed = 1 + Math.random() * 1;
                this.beatTimer = 0;
                this.beatMove = false;
                
                // Configurar según tipo
                switch (type) {
                    case 'silence':
                        this.color = '#000';
                        this.width = 50;
                        this.height = 60;
                        this.health = 5;
                        break;
                    case 'punk':
                        this.color = '#FF00FF';
                        break;
                    case 'scorpion':
                        this.color = '#990000';
                        this.width = 60;
                        this.height = 30;
                        break;
                    case 'bat':
                        this.color = '#660099';
                        this.width = 30;
                        this.height = 20;
                        this.flying = true;
                        break;
                    default:
                        this.color = '#FF0000';
                }
            }
            
            update() {
                // Movimiento al ritmo
                this.beatTimer++;
                if (this.beatTimer >= beatInterval / 16) {
                    this.beatTimer = 0;
                    this.beatMove = !this.beatMove;
                }
                
                if (this.beatMove) {
                    this.x += this.direction * this.speed;
                    
                    // Cambiar dirección al llegar a límites
                    if (this.x < 0 || this.x > canvas.width - this.width) {
                        this.direction *= -1;
                    }
                    
                    // Para enemigos voladores
                    if (this.flying) {
                        this.y += Math.sin(Date.now() / 500) * 0.5;
                    }
                }
                
                // Verificar colisión con jugador
                if (player.invincible === 0 && 
                    player.x + player.width > this.x && 
                    player.x < this.x + this.width && 
                    player.y + player.height > this.y && 
                    player.y < this.y + this.height) {
                    
                    player.invincible = 60; // 1 segundo de invencibilidad
                    lives--;
                    livesDisplay.textContent = lives;
                    createSoundEffect('hit');
                    saveGame();
                    
                    // Mostrar texto "¡¡Mierda!!"
                    const canvasRect = canvas.getBoundingClientRect();
                    const x = this.x + canvasRect.left;
                    const y = this.y + canvasRect.top;
                    showDamageText(x, y);
                    
                    if (lives <= 0) {
                        gameOver.style.display = 'flex';
                        gameRunning = false;
                        localStorage.removeItem('melodiaLegendariaSave');
                    }
                }
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // Dibujar según tipo
                switch (this.type) {
                    case 'silence':
                        // Ojos
                        ctx.fillStyle = '#FFF';
                        ctx.fillRect(this.x + 10, this.y + 15, 10, 10);
                        ctx.fillRect(this.x + 30, this.y + 15, 10, 10);
                        // Boca (tachada)
                        ctx.strokeStyle = '#FFF';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(this.x + 10, this.y + 40);
                        ctx.lineTo(this.x + 40, this.y + 40);
                        ctx.moveTo(this.x + 10, this.y + 40);
                        ctx.lineTo(this.x + 40, this.y + 35);
                        ctx.stroke();
                        break;
                    case 'punk':
                        // Cresta
                        ctx.fillRect(this.x + 5, this.y - 15, 30, 15);
                        // Ojos
                        ctx.fillStyle = '#000';
                        ctx.fillRect(this.x + 10, this.y + 10, 5, 5);
                        ctx.fillRect(this.x + 25, this.y + 10, 5, 5);
                        break;
                    case 'scorpion':
                        // Cola
                        ctx.beginPath();
                        ctx.moveTo(this.x + 30, this.y + 5);
                        ctx.lineTo(this.x + 50, this.y - 10);
                        ctx.lineTo(this.x + 55, this.y);
                        ctx.lineTo(this.x + 50, this.y + 10);
                        ctx.closePath();
                        ctx.fill();
                        // Patas
                        for (let i = 0; i < 4; i++) {
                            ctx.beginPath();
                            ctx.moveTo(this.x + 5 + i * 10, this.y + 5);
                            ctx.lineTo(this.x - 5 + i * 10, this.y - 5);
                            ctx.lineTo(this.x - 8 + i * 10, this.y - 3);
                            ctx.closePath();
                            ctx.fill();
                            
                            ctx.beginPath();
                            ctx.moveTo(this.x + 5 + i * 10, this.y + 25);
                            ctx.lineTo(this.x - 5 + i * 10, this.y + 35);
                            ctx.lineTo(this.x - 8 + i * 10, this.y + 33);
                            ctx.closePath();
                            ctx.fill();
                        }
                        break;
                    case 'bat':
                        // Alas
                        ctx.beginPath();
                        ctx.moveTo(this.x + 15, this.y + 10);
                        ctx.lineTo(this.x - 10, this.y);
                        ctx.lineTo(this.x - 15, this.y - 5);
                        ctx.lineTo(this.x + 15, this.y + 5);
                        ctx.closePath();
                        ctx.fill();
                        
                        ctx.beginPath();
                        ctx.moveTo(this.x + 15, this.y + 10);
                        ctx.lineTo(this.x + 40, this.y);
                        ctx.lineTo(this.x + 45, this.y - 5);
                        ctx.lineTo(this.x + 15, this.y + 5);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    default:
                        // Ojos para enemigo genérico
                        ctx.fillStyle = '#000';
                        ctx.fillRect(this.x + 10, this.y + 10, 5, 5);
                        ctx.fillRect(this.x + 25, this.y + 10, 5, 5);
                }
            }
        }
        
        // Clase de nota musical
        class Note {
            constructor(x, y, type = 'quarter') {
                this.x = x;
                this.y = y;
                this.width = 20;
                this.height = 20;
                this.type = type;
                this.collected = false;
                this.floatTimer = 0;
            }
            
            update() {
                this.floatTimer++;
                this.y += Math.sin(this.floatTimer / 20) * 0.5;
                
                // Verificar colisión con jugador
                if (!this.collected && 
                    player.x + player.width > this.x && 
                    player.x < this.x + this.width && 
                    player.y + player.height > this.y && 
                    player.y < this.y + this.height) {
                    
                    this.collected = true;
                    notes++;
                    notesDisplay.textContent = notes;
                    createSoundEffect('note');
                    saveGame();
                }
            }
            
            draw() {
                if (!this.collected) {
                    ctx.save();
                    ctx.fillStyle = '#FFD700';
                    
                    // Dibujar según tipo de nota
                    if (this.type === 'quarter') {
                        // Nota negra
                        ctx.beginPath();
                        ctx.ellipse(this.x + 10, this.y + 5, 5, 3, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillRect(this.x + 13, this.y + 5, 3, 15);
                    } else if (this.type === 'eighth') {
                        // Corchea
                        ctx.beginPath();
                        ctx.ellipse(this.x + 10, this.y + 5, 5, 3, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillRect(this.x + 13, this.y + 5, 3, 15);
                        // Pluma
                        ctx.beginPath();
                        ctx.moveTo(this.x + 16, this.y + 20);
                        ctx.lineTo(this.x + 20, this.y + 15);
                        ctx.lineTo(this.x + 25, this.y + 20);
                        ctx.closePath();
                        ctx.fill();
                    } else {
                        // Redonda
                        ctx.beginPath();
                        ctx.ellipse(this.x + 10, this.y + 10, 8, 5, 0, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Brillo
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.beginPath();
                    ctx.ellipse(this.x + 8, this.y + 3, 2, 1, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                }
            }
        }
        
        // Clase de objeto de fondo
        class BackgroundObject {
            constructor(x, y, width, height, type) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.type = type;
                this.speed = 0.5;
            }
            
            update() {
                this.x -= this.speed;
                if (this.x < -this.width) {
                    this.x = canvas.width;
                }
            }
            
            draw() {
                ctx.save();
                
                switch (this.type) {
                    case 'tree':
                        // Tronco
                        ctx.fillStyle = '#663300';
                        ctx.fillRect(this.x + this.width / 2 - 5, this.y + 20, 10, this.height - 20);
                        // Copa
                        ctx.fillStyle = '#006600';
                        ctx.beginPath();
                        ctx.arc(this.x + this.width / 2, this.y, 20, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                    case 'cloud':
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.beginPath();
                        ctx.ellipse(this.x + 20, this.y + 10, 25, 15, 0, 0, Math.PI * 2);
                        ctx.ellipse(this.x + 40, this.y + 15, 20, 10, 0, 0, Math.PI * 2);
                        ctx.ellipse(this.x + 60, this.y + 10, 25, 15, 0, 0, Math.PI * 2);
                        ctx.fill();
                        break;
                    case 'amplifier':
                        ctx.fillStyle = '#333';
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                        // Parlante
                        ctx.fillStyle = '#666';
                        ctx.beginPath();
                        ctx.ellipse(this.x + this.width / 2, this.y + this.height / 2, 
                                   this.width / 2 - 5, this.height / 2 - 5, 0, 0, Math.PI * 2);
                        ctx.fill();
                        // Botones
                        ctx.fillStyle = '#FF6D00';
                        for (let i = 0; i < 3; i++) {
                            ctx.beginPath();
                            ctx.arc(this.x + 10 + i * 15, this.y + 10, 3, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        break;
                    case 'building':
                        ctx.fillStyle = '#333';
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                        // Ventanas
                        ctx.fillStyle = '#FF6D00';
                        const windowSize = 8;
                        const gap = 10;
                        for (let row = 0; row < 3; row++) {
                            for (let col = 0; col < 3; col++) {
                                ctx.fillRect(
                                    this.x + gap + col * (windowSize + gap), 
                                    this.y + gap + row * (windowSize + gap), 
                                    windowSize, 
                                    windowSize
                                );
                            }
                        }
                        break;
                }
                
                ctx.restore();
            }
        }
        
        // Crear efectos de sonido simples con Web Audio API
        function createSoundEffect(type) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                let frequency = 440;
                let duration = 0.1;
                
                switch (type) {
                    case 'jump':
                        frequency = 523.25; // Do
                        break;
                    case 'attack':
                        frequency = 659.25; // Mi
                        break;
                    case 'note':
                        frequency = 783.99; // Sol
                        duration = 0.3;
                        break;
                    case 'hit':
                        frequency = 220;
                        duration = 0.5;
                        break;
                    case 'enemyDefeat':
                        frequency = 880;
                        duration = 0.2;
                        break;
                }
                
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (e) {
                console.log('Error de audio:', e);
            }
        }
        
        // Inicializar nivel
        function initLevel(level) {
            player = new Player();
            platforms = [];
            enemies = [];
            notesItems = [];
            backgroundObjects = [];
            beatInterval = 1000 - (level * 50); // Aumenta el ritmo cada nivel
            lastBeatTime = 0;
            
            // Configurar según nivel
            switch (level) {
                case 1: // Bosque del Ritmo Básico
                    // Plataformas
                    platforms.push(new Platform(0, canvas.height - 50, canvas.width, 50, '#006600'));
                    platforms.push(new Platform(200, 350, 100, 20, '#009900'));
                    platforms.push(new Platform(400, 250, 100, 20, '#009900'));
                    platforms.push(new Platform(600, 350, 100, 20, '#009900'));
                    
                    // Enemigos
                    enemies.push(new Enemy(300, canvas.height - 90, 'silence'));
                    enemies.push(new Enemy(500, 210, 'silence'));
                    
                    // Notas
                    notesItems.push(new Note(250, 310));
                    notesItems.push(new Note(450, 210));
                    notesItems.push(new Note(650, 310));
                    notesItems.push(new Note(700, 100, 'eighth'));
                    
                    // Fondo
                    for (let i = 0; i < 5; i++) {
                        backgroundObjects.push(new BackgroundObject(
                            Math.random() * canvas.width * 2, 
                            canvas.height - 150, 
                            40, 
                            100, 
                            'tree'
                        ));
                    }
                    for (let i = 0; i < 3; i++) {
                        backgroundObjects.push(new BackgroundObject(
                            Math.random() * canvas.width * 2, 
                            Math.random() * 100 + 50, 
                            100, 
                            40, 
                            'cloud'
                        ));
                    }
                    
                    player.specialAbility = 'doubleJump';
                    break;
                    
                case 2: // Colinas del Rock
                    // Plataformas
                    platforms.push(new Platform(0, canvas.height - 50, canvas.width, 50, '#333'));
                    platforms.push(new Platform(150, 350, 80, 20, '#666', true));
                    platforms.push(new Platform(350, 300, 80, 20, '#666', true));
                    platforms.push(new Platform(550, 250, 80, 20, '#666', true));
                    platforms.push(new Platform(700, 350, 80, 20, '#666', true));
                    
                    // Enemigos
                    enemies.push(new Enemy(200, canvas.height - 90, 'punk'));
                    enemies.push(new Enemy(400, 260, 'punk'));
                    enemies.push(new Enemy(600, 210, 'punk'));
                    
                    // Notas
                    notesItems.push(new Note(180, 310));
                    notesItems.push(new Note(380, 260));
                    notesItems.push(new Note(580, 210));
                    notesItems.push(new Note(720, 310));
                    notesItems.push(new Note(750, 150, 'eighth'));
                    
                    // Fondo (amplificadores)
                    for (let i = 0; i < 4; i++) {
                        backgroundObjects.push(new BackgroundObject(
                            Math.random() * canvas.width * 2, 
                            canvas.height - 120, 
                            60, 
                            80, 
                            'amplifier'
                        ));
                    }
                    
                    player.specialAbility = 'soundWave';
                    break;
                    
                case 3: // Desierto del Beat
                    // Plataformas móviles
                    platforms.push(new Platform(0, canvas.height - 50, canvas.width, 50, '#CC9900'));
                    platforms.push(new Platform(100, 400, 80, 20, '#FFCC00', true));
                    platforms.push(new Platform(300, 350, 80, 20, '#FFCC00', true));
                    platforms.push(new Platform(500, 300, 80, 20, '#FFCC00', true));
                    platforms.push(new Platform(700, 250, 80, 20, '#FFCC00', true));
                    
                    // Enemigos
                    enemies.push(new Enemy(150, canvas.height - 90, 'scorpion'));
                    enemies.push(new Enemy(350, 310, 'scorpion'));
                    enemies.push(new Enemy(550, 260, 'scorpion'));
                    
                    // Notas
                    notesItems.push(new Note(130, 360));
                    notesItems.push(new Note(330, 310));
                    notesItems.push(new Note(530, 260));
                    notesItems.push(new Note(730, 210));
                    notesItems.push(new Note(400, 150, 'eighth'));
                    
                    player.specialAbility = 'echoShield';
                    break;
                    
                case 4: // Cuevas del Piano Fantasma
                    // Plataformas (teclas de piano)
                    platforms.push(new Platform(0, canvas.height - 50, canvas.width, 50, '#000'));
                    for (let i = 0; i < 7; i++) {
                        platforms.push(new Platform(
                            100 + i * 80, 
                            350 - (i % 2) * 50, 
                            60, 
                            20, 
                            i % 2 === 0 ? '#FFF' : '#000'
                        ));
                    }
                    
                    // Enemigos (murciélagos)
                    enemies.push(new Enemy(200, 200, 'bat'));
                    enemies.push(new Enemy(400, 250, 'bat'));
                    enemies.push(new Enemy(600, 150, 'bat'));
                    
                    // Notas
                    notesItems.push(new Note(130, 300));
                    notesItems.push(new Note(290, 250));
                    notesItems.push(new Note(450, 300));
                    notesItems.push(new Note(610, 200));
                    notesItems.push(new Note(700, 100, 'eighth'));
                    
                    player.specialAbility = 'keyTeleport';
                    break;
                    
                // Puedes agregar más niveles aquí...
                
                default:
                    // Nivel genérico si no hay configuración específica
                    platforms.push(new Platform(0, canvas.height - 50, canvas.width, 50, '#333'));
                    for (let i = 0; i < 5; i++) {
                        platforms.push(new Platform(
                            100 + i * 150, 
                            350 - (i % 2) * 50, 
                            80, 
                            20, 
                            '#666'
                        ));
                        
                        enemies.push(new Enemy(
                            130 + i * 150, 
                            310 - (i % 2) * 50, 
                            'silence'
                        ));
                        
                        notesItems.push(new Note(
                            150 + i * 150, 
                            260 - (i % 2) * 50
                        ));
                    }
                    
                    // Nota especial al final
                    notesItems.push(new Note(700, 100, 'eighth'));
            }
            
            // Actualizar UI
            levelDisplay.textContent = level;
            notesDisplay.textContent = notes;
            livesDisplay.textContent = lives;
        }
        
        // Bucle principal del juego
        function gameLoop() {
            if (!gameRunning) return;
            
            // Actualizar ritmo
            const currentTime = Date.now();
            if (currentTime - lastBeatTime > beatInterval) {
                lastBeatTime = currentTime;
                onBeat = true;
                createSoundEffect('note'); // Sonido de metrónomo
                
                // Efecto visual de ritmo
                ctx.fillStyle = 'rgba(255, 109, 0, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                setTimeout(() => {
                    onBeat = false;
                }, beatInterval / 4);
            }
            
            // Limpiar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dibujar fondo según nivel
            switch (currentLevel) {
                case 1: // Bosque
                    ctx.fillStyle = '#003300';
                    break;
                case 2: // Rock
                    ctx.fillStyle = '#330000';
                    break;
                case 3: // Desierto
                    ctx.fillStyle = '#996600';
                    break;
                case 4: // Piano
                    ctx.fillStyle = '#000033';
                    break;
                default:
                    ctx.fillStyle = '#111';
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Actualizar y dibujar objetos de fondo
            for (const bgObj of backgroundObjects) {
                bgObj.update();
                bgObj.draw();
            }
            
            // Actualizar y dibujar plataformas
            for (const platform of platforms) {
                platform.update();
                platform.draw();
            }
            
            // Actualizar y dibujar enemigos
            for (const enemy of enemies) {
                enemy.update();
                enemy.draw();
            }
            
            // Actualizar y dibujar notas
            let allNotesCollected = true;
            for (const note of notesItems) {
                note.update();
                note.draw();
                if (!note.collected) allNotesCollected = false;
            }
            
            // Actualizar y dibujar jugador
            player.update();
            player.draw();
            
            // Verificar si se completó el nivel
            if (allNotesCollected) {
                // Sumar 3 vidas por completar el nivel
                lives += 3;
                saveGame();
                
                notesCollected.textContent = notes;
                levelComplete.style.display = 'flex';
                gameRunning = false;
            }
            
            // Solicitar siguiente frame
            requestAnimationFrame(gameLoop);
        }
        
        // Event listeners para controles
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            
            switch (e.key) {
                case 'ArrowLeft':
                case 'a':
                    player.velocityX = -player.speed;
                    player.facingRight = false;
                    break;
                case 'ArrowRight':
                case 'd':
                    player.velocityX = player.speed;
                    player.facingRight = true;
                    break;
                case 'ArrowUp':
                case 'w':
                case ' ':
                    player.jump();
                    break;
                case 'j':
                case 'f':
                    player.attack();
                    break;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (!gameRunning) return;
            
            switch (e.key) {
                case 'ArrowLeft':
                case 'a':
                case 'ArrowRight':
                case 'd':
                    if ((e.key === 'ArrowLeft' || e.key === 'a') && player.velocityX < 0) {
                        player.velocityX = 0;
                    } else if ((e.key === 'ArrowRight' || e.key === 'd') && player.velocityX > 0) {
                        player.velocityX = 0;
                    }
                    break;
            }
        });
        
        // Controles táctiles para móviles
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            player.velocityX = -player.speed;
            player.facingRight = false;
        });
        
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (player.velocityX < 0) player.velocityX = 0;
        });
        
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            player.velocityX = player.speed;
            player.facingRight = true;
        });
        
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (player.velocityX > 0) player.velocityX = 0;
        });
        
        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            player.jump();
        });
        
        attackBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            player.attack();
        });
        
        // Botones de UI
        startButton.addEventListener('click', () => {
            startScreen.style.display = 'none';
            currentLevel = 1;
            notes = 0;
            lives = 3;
            initLevel(currentLevel);
            gameRunning = true;
            gameLoop();
            saveGame();
        });
        
        continueButton.addEventListener('click', () => {
            startScreen.style.display = 'none';
            initLevel(currentLevel);
            gameRunning = true;
            gameLoop();
        });
        
        nextLevelButton.addEventListener('click', () => {
            levelComplete.style.display = 'none';
            currentLevel++;
            if (currentLevel > 10) {
                // Juego completado
                alert('¡Felicidades! Has completado Melodía Legendaria y devuelto la música al mundo.');
                currentLevel = 1;
                notes = 0;
                lives = 3;
                localStorage.removeItem('melodiaLegendariaSave');
                startScreen.style.display = 'flex';
                continueButton.style.display = 'none';
            } else {
                initLevel(currentLevel);
                gameRunning = true;
                gameLoop();
                saveGame();
            }
        });
        
        restartButton.addEventListener('click', () => {
            gameOver.style.display = 'none';
            currentLevel = 1;
            notes = 0;
            lives = 3;
            initLevel(currentLevel);
            gameRunning = true;
            gameLoop();
            saveGame();
        });
        
        // Inicializar pantalla de inicio
        initLevel(1); // Solo para mostrar algo en el canvas
        
        // Guardar el juego cuando se cierre la pestaña
        window.addEventListener('beforeunload', () => {
            if (gameRunning) {
                saveGame();
            }
        });
    </script>
</body>
</html>
